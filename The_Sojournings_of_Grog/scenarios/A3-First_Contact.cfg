#textdomain wesnoth-The_Sojournings_of_Grog

#
# TODO: make the teleport also shroud the caves again
# TODO: scroll to units after teleport before door shut

# wmllint: recognize Grog

[scenario]
    id=A3
    next_scenario=A4

    name=_"First Contact"
    map_data="{~add-ons/The_Sojournings_of_Grog/maps/A3-First_Contact.map}"

    victory_when_enemies_defeated=no

    {TURNS 30 25 20}

    {UNDERGROUND}

    {INTRO_AND_SCENARIO_MUSIC "underground.ogg" "vengeful.ogg"}
    {EXTRA_SCENARIO_MUSIC "the_dangerous_symphony.ogg"}
    {EXTRA_SCENARIO_MUSIC "northerners.ogg"}

    [story]
        [part]
            story= _ "They were brought down to meet the Undead master; Elyssa hoped that he would be a mere necromancer. She had met the Undead before, unlike the trolls and she had no delusions about their fate. Since their victory against the Dwarves they had practically been prisoners. Grog gave orders for the Trolls to prepare for a possible attack; Elyssa was not sure it would be enough. As they entered the Undead realm Elyssa wondered if she could create enough fire."
            background=portraits/undead/transparent/lich.png
        [/part]
    [/story]

    [side]
        side=1
        controller=human
        team_name=goodies
        user_team_name=_"Goodies"

        {GROG}
        type="Grog Great"

        shroud=yes
        fog=yes

        {GOLD 100 100 100}
        {INCOME 4 2 0}

        {TROLL_FLAG}
    [/side]

    [side]
        type=Ancient Lich
        id=Mal-Apophis
        name="Mal-Apophis"

        canrecruit=yes
        # removed Wraith from recruit list. No replacement on Easy, Ghosts in Medium, add back in Hard. E_H.
#ifdef EASY
        recruit=Deathblade,Chocobone,Bone Knight
#endif
#ifdef NORMAL
        recruit=Deathblade,Chocobone,Bone Knight,Ghost
#endif
#ifdef HARD
        recruit=Deathblade,Chocobone,Bone Knight,Wraith
#endif
        side=2
        team_name=Undead
        user_team_name= _ "Undead Forces"
        shroud=no
        fog=no

        {GOLD 100 150 200}
        {INCOME 30 40 50}

        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT passive_leader yes}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.0}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat yes}
            {AI_SIMPLE_ALWAYS_ASPECT simple_targeting yes}
            {AI_SIMPLE_ALWAYS_ASPECT village_value 0}
            {AI_SIMPLE_ALWAYS_ASPECT villages_per_scout 0}
            {AI_SIMPLE_ALWAYS_ASPECT grouping no}
            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=20
            [/goal]
        [/ai]

        {FLAG_VARIANT undead}

        #give us a chance
        #{ATTACK_DEPTH 2 2 2}

        {GENERIC_UNIT 2 (Revenant) 34 12}
        {GENERIC_UNIT 2 (Chocobone) 39 15}
        {GENERIC_UNIT 2 (Deathblade) 34 4}
        {GENERIC_UNIT 2 (Revenant) 46 11}
        {GENERIC_UNIT 2 (Chocobone) 41 1}
        {GENERIC_UNIT 2 (Deathblade) 46 3}
        {GENERIC_UNIT 2 (Deathblade) 39 11}
        {GENERIC_UNIT 2 (Revenant) 41 11}
        {GENERIC_UNIT 2 (Chocobone) 39 5}
        {GENERIC_UNIT 2 (Deathblade) 41 5}
        {GENERIC_UNIT 2 (Chocobone) 34 11}
        {GENERIC_UNIT 2 (Bone Shooter) 40 14}
        {GENERIC_UNIT 2 (Chocobone) 40 1}
        {GENERIC_UNIT 2 (Bone Shooter) 46 4}
        {GENERIC_UNIT 2 (Bone Knight) 40 12}
        {GENERIC_UNIT 2 (Bone Knight) 40 3}
        {GENERIC_UNIT 2 (Deathblade) 43 6}
#ifdef HARD
        {GENERIC_UNIT 2 (Wraith) 37 10}
        {GENERIC_UNIT 2 (Wraith) 37 6}
        {GENERIC_UNIT 2 (Wraith) 43 10}
#else
        {GENERIC_UNIT 2 (Ghost) 37 10}
        {GENERIC_UNIT 2 (Ghost) 37 6}
        {GENERIC_UNIT 2 (Ghost) 43 10}
#endif
        #surrounding guards. Deathblade on medium due to +1 strikes and +1 MP. E_H.
#ifdef EASY
        {GENERIC_UNIT 2 (Revenant) 27 15}
        {GENERIC_UNIT 2 (Revenant) 31 19}
        {GENERIC_UNIT 2 (Revenant) 32 13}
        {GENERIC_UNIT 2 (Revenant) 34 15}
        {GENERIC_UNIT 2 (Revenant) 27 19}
#endif
#ifdef NORMAL
        {GENERIC_UNIT 2 (Deathblade) 27 15}
        {GENERIC_UNIT 2 (Deathblade) 31 19}
        {GENERIC_UNIT 2 (Deathblade) 32 13}
        {GENERIC_UNIT 2 (Deathblade) 34 15}
        {GENERIC_UNIT 2 (Deathblade) 27 19}
#endif
#ifdef HARD
        {GENERIC_UNIT 2 (Draug) 27 15}
        {GENERIC_UNIT 2 (Draug) 31 19}
        {GENERIC_UNIT 2 (Draug) 32 13}
        {GENERIC_UNIT 2 (Draug) 34 15}
        {GENERIC_UNIT 2 (Draug) 27 19}
#endif
    [/side]

    #In case of supreme luck
    #{FORCE_CHANCE_TO_HIT (side=1) (id=Mal-Apophis) 0 ()}
    [event]
        name=last breath
        first_time_only=no
        [filter]
            id=Mal-Apophis
        [/filter]

        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "Mal-Apophis quaffs an healing potion!"
            sound=potion.ogg
        [/message]

        {FULL_HEAL id=Mal-Apophis}

        [sound]
            name=heal.wav
        [/sound]

        [redraw]
        [/redraw]
    [/event]

    [side]
        type=Armageddon Drake
        id=Drake Ambassador
        name="Drake Ambassador"

        canrecruit=yes
        recruit=Drake Burner,Sky Drake
        side=3
        team_name=Undead
        user_team_name= _ "Drake's Forces"
        shroud=no

        {GOLD 100 150 200}
        {INCOME 30 40 50}

        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT passive_leader yes}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.0}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_ignore_bad_combat yes}
            {AI_SIMPLE_ALWAYS_ASPECT simple_targeting yes}
            {AI_SIMPLE_ALWAYS_ASPECT village_value 0}
            {AI_SIMPLE_ALWAYS_ASPECT villages_per_scout 0}
            {AI_SIMPLE_ALWAYS_ASPECT grouping no}
            [goal]
                name=target
                [criteria]
                    side=1
                [/criteria]
                value=20
            [/goal]
        [/ai]

        {FLAG_VARIANT drake}

        #created here to give him a look in on the recruiting clever (Eros)
        {GENERIC_UNIT 3 (Sky Drake) 40 7}
        {GENERIC_UNIT 3 (Sky Drake) 39 7}
        {GENERIC_UNIT 3 (Sky Drake) 41 7}
    [/side]

    #In case of supreme luck
    #{FORCE_CHANCE_TO_HIT (side=1) (id=Drake Ambassador) 0 ()}
    [event]
        name=last breath
        first_time_only=no
        [filter]
            id=Drake Ambassador
        [/filter]

        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "The Drake Ambassador quaffs an healing potion!"
            sound=potion.ogg
        [/message]

        {FULL_HEAL id="Drake Ambassador"}

        [sound]
            name=heal.wav
        [/sound]

        [redraw]
        [/redraw]
    [/event]

    [side]
#ifdef EASY
        type=Death Baron
#else
        type=Death Knight
#endif
        id=L
        name= _ "Lotin"
        canrecruit=yes
#ifdef EASY
        recruit=Skeleton,Skeleton Archer
#endif
#ifdef NORMAL
        recruit=Skeleton,Skeleton Archer,Ghost
#endif
#ifdef HARD
        recruit=Skeleton,Skeleton Archer,Ghost,Chocobone
#endif
        side=4
        team_name=Undead
        user_team_name= _ "Gate Guard"
        shroud=no
        {GOLD 80 120 160}

        [ai]
#ifdef EASY
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "fighter,fighter,archer,archer"}
#else
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "fighter,fighter,archer,archer,scout"}
#endif
        [/ai]

        {FLAG_VARIANT undead}
    [/side]

#ifdef HARD
    [event]
        name=prestart
        [terrain]
            x=25,28,23,24,22,28,26,26,19,27,11,14,12,12,9
            y=21,17,27,21,29,20,19,24,28,20,34,34,35,32,36
            terrain=Uu^Ii
        [/terrain]
        [redraw][/redraw]
    [/event]
#endif

#ifdef NORMAL
    [event]
        name=prestart
        [terrain]
            x=25,25,28,23,24,22,28,26,26,19,27,11,14,12,12,9,24,21,24,23,14,10,8
            y=20,21,17,27,21,29,20,19,24,28,20,34,34,35,32,36,25,29,26,23,32,26,32
            terrain=Uu^Ii
        [/terrain]
        [redraw][/redraw]
    [/event]
#endif

#ifdef EASY
    [event]
        name=prestart
        [terrain]
            x=25,25,28,23,24,22,28,26,26,19,27,11,14,12,12,9,24,21,24,23,14,10,8,15,17,28,22,25
            y=20,21,17,27,21,29,20,19,24,28,20,34,34,35,32,36,25,29,26,23,32,26,32,31,34,21,28,25
            terrain=Uu^Ii
        [/terrain]
        [redraw][/redraw]
    [/event]
#endif

    [time_area]
        # runes are placed at 14,31 and 17,33
        x=   13,   14,   15,   16,   17,   18
        y=31-32,30-32,31-32,32-33,32-34,32-33
        {RUNIC}
    [/time_area]

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                description= _ "Escape the Lich"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Grog"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Elyssa"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]

        [remove_shroud]
            side=1
            x,y=9,65
            radius=10
        [/remove_shroud]
    [/event]

    [event]
        name=start
        #disallow recruitment
        [disallow_recruit]
            side=1
            type=Troll Whelp
        [/disallow_recruit]

        #Failsafe lines, just in case that the player doesn't have enough units available for recall.
        #Bug reported by ydcl, bugfix suggested by Anonymissimus. Thank you both. Elvish_Hunter
        [if]
            [not]
                [have_unit]
                    type=Troll Warrior,Troll Boulderlobber,Troll,Troll Rocklobber,Troll Whelp
                    count=5-99999
                    search_recall_list=yes
                [/have_unit]
            [/not]
            [then]
                # wmlscope: start ignoring
                {GENERIC_UNIT 1 (Troll Whelp) recall recall}
                {GENERIC_UNIT 1 (Troll Whelp) recall recall}
                {GENERIC_UNIT 1 (Troll Whelp) recall recall}
                {GENERIC_UNIT 1 (Troll Whelp) recall recall}
                {GENERIC_UNIT 1 (Troll Whelp) recall recall}
                # wmlscope: stop ignoring
            [/then]
        [/if]

        #[if]
        #    [not]
        #        [have_unit]
        #            race=elf
        #            search_recall_list=yes
        #        [/have_unit]
        #    [/not]
        #    [then]
        #        # wmlscope: start ignoring
        #        {GENERIC_UNIT 1 (Desert Hunter) recall recall}
        #        # wmlscope: stop ignoring
        #    [/then]
        #[/if]

        # recall bodyguards
        # these will be, if possible, a Troll Warrior, a Boulderlobber, a Troll, a Rocklobber and a Whelp
#define RECALL_IF_AVAILABLE TYPE SUBSTITUTION
    [if]
        [have_unit]
            side=1
            type={TYPE}
            search_recall_list=yes
        [/have_unit]
        [then]
            [recall]
                type={TYPE}
            [/recall]
        [/then]
        [else]
            [recall]
                type={SUBSTITUTION}
            [/recall]
        [/else]
    [/if]
#enddef

        {RECALL_IF_AVAILABLE "Troll Warrior"       "Troll Whelp"}
        {RECALL_IF_AVAILABLE "Troll"               "Troll Whelp"}
        {RECALL_IF_AVAILABLE "Troll Boulderlobber" "Troll Whelp"}
        {RECALL_IF_AVAILABLE "Troll Rocklobber"    "Troll Whelp"}
        [recall]
            type=Troll Whelp
        [/recall]

        [recall]
            id=Elyssa
            x,y=31,16
        [/recall]

        #clear the recall list
        [store_unit]
            [filter]
                side=1
                x,y=recall,recall
            [/filter]
            variable=Grog_recall_list
            kill=yes
        [/store_unit]

        #initialising a variable to check if the bridge was already destroyed, to fix a bug reported by Daravel. E_H.
        [set_variable]
            name=bridge_destroyed
            value=no
        [/set_variable]

        [scroll_to]
            x,y=36,11
        [/scroll_to]

        [lift_fog]
            side=1
            x,y=40,8
            radius=10
            multiturn=yes
        [/lift_fog]
        [remove_shroud]
            side=1
            x,y=40,8
            radius=10
        [/remove_shroud]

        [message]
            speaker=Elyssa
            #change not just a paltry necromancer but a full blown lich
            message= _ "A Lich! I still remember when Garak turned to the dark magics. We are in trouble."
        [/message]

        #[message]
        #    speaker=Elyssa
        #	message= _ "I don't like this; a Lich is bad news."
        #[/message]

        #bold to put emphasis on what the lich thinks about himself. E_H..
        [message]
            speaker=Mal-Apophis
            message=_ "A Lich? Do you think I am some kind of rotting corpse? <b>I am Mal-Apophis! The lich... The ancient Lich!</b> I have defied the kingdoms of life and death since the former years and you dare call me <i>a mere Lich?</i>"
        [/message]

        [message]
            speaker=Mal-Apophis
            message=_ "Your ignorance is pardonable. It is inconceivable that you could imagine such a being as <b>me!</b>"
        [/message]

        [message]
            speaker=Mal-Apophis
            message=_ "Let me present the ambassador of my newest ally."
        [/message]

        [message]
            speaker=Elyssa
            message=_ "A Drake! I have greatly wished to see one..."
        [/message]

        [message]
            speaker=Drake Ambassador
            message=_ "BREAAAKFAAAST!" # wmllint: no spellcheck
        [/message]

        [message]
            #TODO have a elf role macro here
            speaker=Grog
            message=_ "Perhaps not this close!"
        [/message]

        [message]
            speaker=Mal-Apophis
            message=_ "As thanks for your endeavors in my service, I will resurrect you as my principal servants!"
        [/message]

        [message]
            speaker=Grog
            message=_ "Grog dun like hissing thing. Grog want smash it."
        [/message]

        [message]
            speaker=Elyssa
            # wmllint: local spelling un-brain
            message=_ "Slaves! Not before I fry your delusional un-brain!"
        [/message]

        #[message]
        #    speaker=bodyguard_1
        #	message=_ "Ha! Good one."
        #[/message]

        # [flash_screen] is a custom Lua tag. E_H.
        [flash_screen]
            color=white
        [/flash_screen]
        {REPEAT 2 (
            {QUAKE "fire.wav"}
            [flash_screen]
                color=black
            [/flash_screen]
            {RANDOM (dragonstick.ogg,lightning.ogg,magic-faeriefire.ogg)}
            {QUAKE $random}
            {CLEAR_VARIABLE random}
            {RANDOM (lich-hit-1.ogg,lich-hit-2.ogg)}
            [sound]
                name=$random
            [/sound]
            {CLEAR_VARIABLE random}
            {RANDOM (skeleton-big-hit-1.ogg,skeleton-big-hit-2.ogg,skeleton-big-hit-3.ogg)}
            [sound]
                name=$random
            [/sound]
            {CLEAR_VARIABLE random}
            [flash_screen]
                color=blue
            [/flash_screen]
        )}

        #reduce enemy hp
        #cant use modify unit. shame! (EROS)
        # don't worry Eros, I know Lua and I'll use it.
        # It does exactly the same thing as the old WML structure, and also floats the damage label. E_H.
        [lua]
            code=<<
			--[[local units_to_damage = wesnoth.get_units { race = "undead", { "or", { race = "drake" } }, { "not", { id = "L" } } }
			for index, unit in ipairs ( units_to_damage ) do
				if unit.valid then
					unit.hitpoints = math.floor ( unit.hitpoints * 0.75 )
					wesnoth.float_label ( unit.x, unit.y, string.format( "<span color='red'>%d</span>", unit.max_hitpoints - unit.hitpoints ) )
				end
			end]]
		>>
        [/lua]
        [harm_unit]
            [filter]
                race=undead
                [or]
                    race=drake
                [/or]
            [/filter]
            amount="$($this_unit.hitpoints*0.25)"
            animate=no
            kill=no
            fire_event=no
        [/harm_unit]

        [message]
            speaker=Mal-Apophis
            message=_ "AAAAAHHHHH! Guards! Kill them all." # wmllint: no spellcheck
        [/message]

        [message]
            speaker=Elyssa
            message=_ "I don't think so. Melt in the hot suns Lich!"
        [/message]

        [flash_screen]
            color=white
        [/flash_screen]
        {REPEAT 3 (
            {QUAKE "fire.wav"}
            [flash_screen]
                color=yellow # like the sun.
            [/flash_screen]
            {RANDOM (dragonstick.ogg,lightning.ogg,magic-faeriefire.ogg)}
            {QUAKE $random}
            {CLEAR_VARIABLE random}
            {RANDOM (lich-hit-1.ogg,lich-hit-2.ogg)}
            [sound]
                name=$random
            [/sound]
            {CLEAR_VARIABLE random}
            {RANDOM (skeleton-big-hit-1.ogg,skeleton-big-hit-2.ogg,skeleton-big-hit-3.ogg)}
            [sound]
                name=$random
            [/sound]
            {CLEAR_VARIABLE random}
            [flash_screen]
                color=cyan
            [/flash_screen]
        )}

        #reduce enemy hp
        #cant use modify unit. shame! (EROS)
        # ditto as above. E_H.

        [lua]
            code=<<
			--[[local units_to_damage = wesnoth.get_units { race = "undead", { "or", { race = "drake" } }, { "not", { id = "L" } } }
			for index, unit in ipairs ( units_to_damage ) do
				if unit.valid then
					local hp_before_attack = unit.hitpoints
					unit.hitpoints = math.floor ( unit.hitpoints * 0.67 )
					wesnoth.float_label ( unit.x, unit.y, string.format( "<span color='red'>%d</span>", hp_before_attack - unit.hitpoints ) )
				end
			end]]
		>>
        [/lua]
        [harm_unit]
            [filter]
                race=undead
                [or]
                    race=drake
                [/or]
            [/filter]
            amount="$($this_unit.hitpoints*0.33)"
            animate=no
            kill=no
            fire_event=no
        [/harm_unit]

        [message]
            speaker=Elyssa
            message=_ "Well, that was the best I could manage. Your move, Grog."
        [/message]

        [message]
            speaker=Grog
            message=_ "Grog say run!"
        [/message]

        # and this is per Anonymissimus' suggestion.
        [message]
            speaker=Elyssa
            message=_ "This cave is full of side tunnels. Let's try to stay on the main road, for we don't know how much the other tunnels will slow us down."
        [/message]

        [message]
            speaker=Drake Ambassador
            message=_ "RRRRRRAAAAAAAUUUUUURRRGGHHHHH!" # wmllint: no spellcheck
        [/message]

        #	[message]
        #		speaker=narrator
        #		message= _ "You glimpse a vague outline of a door to the south.  From the east and west strange blue lights are emanating."
        #		image=wesnoth-icon.png
        #	[/message]

        [reset_fog]
            side=1
            x,y=40,8
            radius=10
        [/reset_fog]
        [place_shroud]
            side=1
            x,y=40,8
            radius=10
        [/place_shroud]
    [/event]

    # we will make things more interesting by giving the units more xp
    # mod from utbs (Eros)
    # replaced with a Lua code. E_H.
    [event]
        name=recruit
        first_time_only=no
        [filter]
            side=2,3,4
        [/filter]

        [lua]
            code=<<
			local t = ...
			local unit = wesnoth.get_units( { id = t.id } )[1]
			local min = math.floor( unit.max_experience * 0.5 )
			local max = math.ceil( unit.max_experience * 0.9 )
			
			local function sync()
				return { amount = math.random( min, max ) }
			end
			
			local result = wesnoth.synchronize_choice(sync)
			unit.experience = result.amount
		>>
            [args]
                id=$unit.id
            [/args]
        [/lua]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                #was 20,29
                x,y=16,31
                radius=4
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=unit.id
                equals=Elyssa
            [/variable]
            [then]
                [message]
                    speaker=Elyssa
                    # wmllint: local spelling er un-kill
                    message=_ "Dwarven runes! Have a look and see what they do. I need to save my magic for the Lich; he's going to be hard to... err... un-kill."
                [/message]
            [/then]
            [else]
                [if]
                    [variable]
                        name=unit.race
                        equals=troll
                    [/variable]
                    [then]
                        [message]
                            speaker=unit
                            message=_ "Runes broken?"
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=unit
                            message=_ "How broken are these runes then?"
                        [/message]
                    [/else]
                [/if]

                [message]
                    speaker=Elyssa
                    message=_ "Step on them and find out. I need to save my magic; that Lich will be hard to... err... un-kill."
                [/message]
            [/else]
        [/if]
    [/event]

#define NON_SAFE_LOCATIONS
    x=15,16,17,18
    y=31,30,32,31
#enddef

    [event]
        name=moveto
        first_time_only=no

        [filter]
            x=14,17
            y=31,33
            side=1
        [/filter]

        [if]
            [have_unit]
                x,y=14,31
                side=1
            [/have_unit]
            [and]
                [have_unit]
                    x,y=17,33
                    side=1
                [/have_unit]
            [/and]
            [and]
                [variable]
                    name=bridge_destroyed
                    equals=no
                [/variable]
            [/and]

            [then]
                [if]
                    [have_unit]
                        {NON_SAFE_LOCATIONS}
                        side=1
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Elyssa
                            message= _"We can't destroy the bridge if one of us is still on it!"
                        [/message]
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=unit.race
                                equals=troll
                            [/variable]
                            [then]
                                [message]
                                    speaker=unit
                                    message=_ "Rune not work again."
                                [/message]
                            [/then]
                            [else]
                                [message]
                                    speaker=unit
                                    message=_ "Nothing happened. Typical."
                                [/message]
                            [/else]
                        [/if]

                        [message]
                            speaker=Elyssa
                            message= _ "Dwarvish runes are <i>so</i> reliable... It looks like I'll have to do the dirty work by myself. Again."
                        [/message]

                        [scroll_to]
                            x,y=18,30
                        [/scroll_to]

                        [delay]
                            time=1000
                        [/delay]

                        {THUNDER_AND_LIGHTNING 15 31}

                        [terrain]
                            x=15
                            y=31
                            terrain=Qxu
                        [/terrain]

                        [terrain]
                            x=16
                            y=30
                            terrain=Qxu
                        [/terrain]

                        [kill]
                            x,y=15,31
                            animate=yes
                            fire_event=yes
                        [/kill]

                        [kill]
                            x,y=16,30
                            animate=yes
                            fire_event=yes
                        [/kill]

                        [redraw]
                        [/redraw]

                        [delay]
                            time=750
                        [/delay]

                        [scroll_to]
                            x,y=17,32
                        [/scroll_to]

                        {THUNDER_AND_LIGHTNING 17 32}

                        [terrain]
                            x=17
                            y=32
                            terrain=Qxu
                        [/terrain]

                        [terrain]
                            x=18
                            y=31
                            terrain=Qxu
                        [/terrain]

                        [kill]
                            x,y=17,32
                            animate=yes
                            fire_event=yes
                        [/kill]

                        [kill]
                            x,y=18,31
                            animate=yes
                            fire_event=yes
                        [/kill]

                        [redraw]
                        [/redraw]

                        [set_variable]
                            name=bridge_destroyed
                            value=yes
                        [/set_variable]
                        #			[message]
                        #				speaker=unit
                        #				message= _"Death won't be difficult to find here."
                        #			[/message]
                    [/else]
                [/if]
            [/then]
        [/if]
    [/event]

    [event]
        name=attack

        [filter]
            id=Mal-Apophis
        [/filter]

        [message]
            speaker=Mal-Apophis
            #message= _ "You can't hit me!"
            message= _ "You can't kill me!"
        [/message]
    [/event]

    [event]
        name=attack

        [filter]
            id=Drake Ambassador
        [/filter]

        [message]
            speaker=Drake Ambassador
            message= _ "Grrrgghhh." # wmllint: no spellcheck
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=L
        [/filter]

        [message]
            speaker=L
            message= _ "Master, I have failed..."
        [/message]

        [remove_shroud]
            x,y=14,40
            radius=4
            side=1
        [/remove_shroud]

        [if]
            [variable]
                name=second_unit.race
                equals=troll
            [/variable]
            [then]
                [message]
                    speaker=second_unit
                    message= _ "$second_unit.name see gate."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=second_unit
                    message= _ "Look, a gateway! Maybe we can get out and close it!"
                [/message]
            [/else]
        [/if]

        [message]
            speaker=Elyssa
            message= _ "Excellent, a way out of this nightmare. Grog, see if you can close it behind us; I don't hold out hope though, my opinion of Dwarvish construction is waning rapidly."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "It <i>should</i> close from the outside; if not..."
        [/message]

        [message]
            speaker=Grog
            message= _ "Hit with hammer."
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            [filter_location]
                x,y=20,49
                radius=5
            [/filter_location]
        [/filter]

        [store_unit]
            [filter]
                side=1
            [/filter]
            variable=about_to_teleport
            kill=no
        [/store_unit]

        # does [teleport] work on all matching units, or only on the first one?
        {FOREACH about_to_teleport index}
            [teleport]
                [filter]
                    id=$about_to_teleport[$index].id
                [/filter]
                x=20
                y=48
                animate=no
            [/teleport]
        {NEXT index}
        {CLEAR_VARIABLE about_to_teleport}

        [terrain]
            x,y=16,43
            terrain=Xos
        [/terrain]

        [sound]
            name=rumble.ogg
        [/sound]

        [redraw][/redraw]

        [message]
            speaker=narrator
            message= _ "Cogs turn and iron grinds as a heavy gate descends behind them."
            image=wesnoth-icon.png
        [/message]

        # does not work. It seems like teleport erases auto stored unit variable. Maybe I should use move_unit? E_H.
        #[if]
        #	[variable]
        #		name=unit.race
        #		equals=troll
        #	[/variable]
        #	[then]
        #		[message]
        #			speaker=unit
        #			message= _ "What did that."
        #		[/message]
        #	[/then]
        #	[else]
        #		[message]
        #			speaker=unit
        #			message= _ "Who did that?"
        #		[/message]
        #	[/else]
        #[/if]

        [message]
            speaker=Elyssa
            message= _ "It closed itself. How convenient."
        [/message]

        [message]
            speaker=Grog
            # Griknagh is the name of the Trolls' god, as in UtBS. E_H
            message= _ "Thank Griknagh for help Trolls."
        [/message]

        # does not work. Replaced with a message assigned to Grog. E_H.
        #[if]
        #	[variable]
        #		name=unit.race
        #		equals=troll
        #	[/variable]
        #	[then]
        #		[message]
        #			speaker=unit
        #			message= _ "Griknagh now is help us."
        #		[/message]
        #	[/then]
        #	[else]
        #		[message]
        #			speaker=unit
        #			message= _ "Eloh is surely smiling upon us this day."
        #		[/message]
        #	[/else]
        #[/if]

        {TROLL_ROLE_SMALL "shame"}

        # we have a prisoner, comment about it. E_H
        [message]
            role=shame
            message= _ "Shame we could not release all the prisoners."
            [show_if]
                [variable]
                    name=prisoners.length
                    greater_than=0
                [/variable]
            [/show_if]
        [/message]

        {TROLL_ROLE_BIG "advice"}

        [message]
            role=advice
            message= _ "Gate not last long. Bones go to Troll home now."
        [/message]

        [message]
            speaker=Grog
            message= _ "Grog need go to Troll village."
        [/message]

        [endlevel]
            bonus=yes
            result=victory
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    #####################################################
    # CAPTURE CODE (isolated for convenience)
    # we store the units hp before it is attacked
    # if the attack kills it we then store it with the hp
    # it had before it was attacked.
    # we then put a event on the killer to mark our units
    # release when we kill it.
    #####################################################

    #two talk methods depeding on whether you have heard it before
    [event]
        name=last breath
        first_time_only=yes

        [filter]
            side=1
            [not]
                id=Grog
            [/not]
            [not]
                id=Elyssa
            [/not]
        [/filter]

        #have some conversation
        [message]
            speaker=second_unit
            message= _ "Got you!"
        [/message]

        [if]
            [variable]
                name=unit.race
                equals=troll
            [/variable]
            [then]
                [message]
                    speaker=unit
                    message= _ " $unit.name says this one stinks."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    # wmllint: local spelling Aaahh!
                    message= _ "Aaahh! Help me!"
                [/message]
            [/else]
        [/if]

        [message]
            speaker=narrator
            message=_"To rescue this unit kill its captor."
            image=wesnoth-icon.png
        [/message]

        [event]
            name=last breath
            first_time_only=no

            [filter]
                side=1
                [not]
                    id=Grog
                [/not]
                [not]
                    id=Elyssa
                [/not]
            [/filter]

            #have some conversation
            [message]
                speaker=second_unit
                message= _ "And you as well!"
            [/message]
        [/event]
    [/event]

    #unit death
    #unit = us
    #2unit = undead
    [event]
        name=die
        first_time_only=no

        [filter]
            side=1
            [not]
                id=Grog
            [/not]
            [not]
                id=Elyssa
            [/not]
        [/filter]

        [filter_second]
            side=2,3,4
        [/filter_second]

        [floating_text]
            x,y=$unit.x,$unit.y
            text= _ "<span foreground='red'>unit captured</span>"
        [/floating_text]

        #store a list of captured units inside the killers. E_H.
        # set_variables doesn't seem to work inside unit.variables
        # so I'm using a workaround. E_H
        [set_variable]
            name=temp_index
            value=$second_unit.variables.captured.length
        [/set_variable]
        # given that the last index of an array is lenght - 1,
        # storing something at index lenght means, in fact,
        # appending something to the array's end. E_H
        [set_variable]
            name=second_unit.variables.captured[$temp_index].id
            value=$unit.id
        [/set_variable]
        {CLEAR_VARIABLE temp_index}

        #[set_variables]
        #	name=second_unit.variables.captured
        #	mode=append
        #	[value]
        #		id=$unit.id
        #	[/value]
        #[/set_variables]
        [unstore_unit]
            variable=second_unit
            find_vacant=no
        [/unstore_unit]

        # store our unit in a prisoners array
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=prisoners
            mode=append
            kill=no # they'll be killed anyway
        [/store_unit]

        #give the killer a icon to show that he has a prisoner
        [unit_overlay]
            id=$second_unit.id
            image=misc/prisoner.png
        [/unit_overlay]

        # this should order the killer to go back to the Lich's castle. E_H.
        [modify_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            goto_x,goto_y=40,6
        [/modify_unit]
    [/event]

    #recognise deaths of any killers

    [event]
        name=die
        first_time_only=no

        [filter]
            side=2,3,4
        [/filter]

        # the only safe way to delete items from an array is by iterating it backwards
        # so we have a REV_FOREACH and a PREVIOUS macros to help me in this task. E_H

# wmlindent: start ignoring
#define REV_FOREACH ARRAY_VALUE VAR
    # last index of an array is always length-1
    {VARIABLE {VAR} "$(${ARRAY_VALUE}.length)-1"}
    [while]
        [variable]
            name={VAR}
            greater_than_equal_to=0
        [/variable]
        [do]
#enddef
#define PREVIOUS VAR
            [set_variable]
                name={VAR}
                sub=1
            [/set_variable]
        [/do]
    [/while]
    {CLEAR_VARIABLE {VAR}}
#enddef
# wmlindent: stop ignoring

        [if]
            [variable]
                name=unit.variables.captured.length
                greater_than=0
            [/variable]
            [then]
                {REV_FOREACH prisoners index}
                {FOREACH unit.variables.captured index2}
                    [if]
                        [variable]
                            name=prisoners[$index].id
                            equals=$unit.variables.captured[$index2].id
                        [/variable]
                        [then]
                            # give back half hitpoints
                            {VARIABLE prisoners[$index].hitpoints "$(($prisoners[$index].max_hitpoints)/2)"}
                            #give it full movement so it can run away
                            {VARIABLE prisoners[$index].moves $prisoners[$index].max_moves}
                            #give attack chance
                            {VARIABLE prisoners[$index].attacks_left 1}
                            #unstore our unit displaying a message on the way
                            [unstore_unit]
                                variable=prisoners[$index]
                                x,y=$unit.x,$unit.y
                                find_vacant=yes
                                check_passability=yes
                                text=_"<span color='green'>unit released</span>"
                            [/unstore_unit]

                            #for some reason, the unstored unit is not immediatly showed. So, redraw. E_H.
                            [redraw][/redraw]

                            [message]
                                speaker=$prisoners[$index].id
                                message= _ "Thank you."
                            [/message]

                            #have some conversation
                            [message]
                                speaker=second_unit
                                message= _ "It was nothing!"
                            [/message]
                            {CLEAR_VARIABLE prisoners[$index]} # since we're iterating backwards we should be safe
                        [/then]
                    [/if]
                {NEXT index2}
                {PREVIOUS index}
            [/then]
        [/if]
    [/event]

    #victory clear variables
    [event]
        name=victory
        # store a list of our surviving bodyguards
        # this is for use in the next scenario
        [store_unit]
            [filter]
                side=1
                [not]
                    id=Grog,Elyssa
                [/not]
            [/filter]
            variable=bodyguards
            kill=no
        [/store_unit]

        # reallow recruitment
        [allow_recruit]
            side=1
            type=Troll Whelp
        [/allow_recruit]

        #restore recall list
        {FOREACH Grog_recall_list index}
            [unstore_unit]
                variable=Grog_recall_list[$index]
                x,y=recall,recall
            [/unstore_unit]
        {NEXT index}

        {CLEAR_VARIABLE Grog_recall_list}

        {CLEAR_VARIABLE "hp_before_attack"}

        #don't clear prisoners array as we will use it again in A7
        {CLEAR_VARIABLE bridge_destroyed}
    [/event]

    {~add-ons/The_Sojournings_of_Grog/utils/tsog-deaths.cfg}
[/scenario]

# make these macros local... for now
#undef RECALL_IF_AVAILABLE
#undef REV_FOREACH
#undef PREVIOUS
